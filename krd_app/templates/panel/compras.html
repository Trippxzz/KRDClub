{% extends 'panel/base_admin.html' %}

{% block title %}Compras{% endblock %}
{% block page_title %}Gestión de Compras{% endblock %}
{% block page_subtitle %}Registros de compras a proveedores{% endblock %}

{% block content %}
<!-- Header -->
<div class="flex justify-between items-center mb-6">
    <div class="flex gap-4">
        <div class="bg-white rounded-lg p-4 border border-gray-100">
            <p class="text-sm text-gray-500">Total Compras</p>
            <p class="text-2xl font-bold text-gray-900">{{ compras|length }}</p>
        </div>
        <div class="bg-white rounded-lg p-4 border border-gray-100">
            <p class="text-sm text-gray-500">Total Neto</p>
            <p class="text-2xl font-bold text-gray-900">${{ total_neto|floatformat:0|default:"0" }}</p>
        </div>
        <div class="bg-white rounded-lg p-4 border border-gray-100">
            <p class="text-sm text-gray-500">IVA (19%)</p>
            <p class="text-2xl font-bold text-orange-600">${{ total_iva|floatformat:0|default:"0" }}</p>
        </div>
        <div class="bg-white rounded-lg p-4 border border-gray-100">
            <p class="text-sm text-gray-500">Total Bruto</p>
            <p class="text-2xl font-bold text-green-600">${{ total_bruto|floatformat:0|default:"0" }}</p>
        </div>
    </div>
    <a href="{% url 'crear_compra' %}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
        <i class="fas fa-plus mr-2"></i>
        Nueva Compra
    </a>
</div>

<!-- Tabla de Compras -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="text-left px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Folio</th>
                    <th class="text-left px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Proveedor</th>
                    <th class="text-left px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Fecha</th>
                    <th class="text-center px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Productos</th>
                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Neto</th>
                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-600 uppercase">IVA</th>
                    <th class="text-right px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Total Bruto</th>
                    <th class="text-center px-6 py-4 text-xs font-semibold text-gray-600 uppercase">PDF</th>
                    <th class="text-center px-6 py-4 text-xs font-semibold text-gray-600 uppercase">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for compra in compras %}
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4">
                        <span class="font-mono font-bold text-blue-600">{{ compra.folio }}</span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-building text-gray-500"></i>
                            </div>
                            <span class="font-medium text-gray-900">{{ compra.proveedor }}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <p class="text-gray-900">{{ compra.fecha|date:"d/m/Y" }}</p>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-sm font-medium">
                            {{ compra.productos_compra.count }} productos
                        </span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-gray-900">${{ compra.neto|floatformat:0 }}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-orange-600 text-sm">${{ compra.iva|floatformat:0 }}</span>
                    </td>
                    <td class="px-6 py-4 text-right">
                        <span class="text-lg font-bold text-green-700">${{ compra.bruto|floatformat:0 }}</span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        {% if compra.pdf %}
                        <a href="{{ compra.pdf.url }}" target="_blank" 
                           class="text-red-600 hover:text-red-800 transition" title="Ver PDF">
                            <i class="fas fa-file-pdf text-xl"></i>
                        </a>
                        {% else %}
                        <span class="text-gray-300"><i class="fas fa-file-pdf text-xl"></i></span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button onclick="verDetalleCompra({{ compra.id }})" 
                                class="p-2 text-gray-600 hover:text-blue-600 hover:bg-blue-50 rounded-lg transition"
                                title="Ver detalle">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="9" class="px-6 py-12 text-center text-gray-500">
                        <i class="fas fa-truck-loading text-4xl mb-4 text-gray-300"></i>
                        <p>No hay compras registradas</p>
                        <a href="{% url 'crear_compra' %}" class="text-blue-600 hover:underline mt-2 inline-block">
                            Registrar primera compra
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


<!-- Modal Detalle Compra -->
<div id="modal-detalle-compra" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-6 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-gray-900">Detalle de Compra</h3>
            <button onclick="cerrarModalCompra()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
        <div id="detalle-compra-contenido">
            <!-- Se llena dinámicamente -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const comprasData = {
    {% for compra in compras %}
    {{ compra.id }}: {
        folio: "{{ compra.folio }}",
        proveedor: "{{ compra.proveedor }}",
        fecha: "{{ compra.fecha|date:'d/m/Y' }}",
        subtotal_neto: {{ compra.subtotalc }},
        productos: [
            {% for item in compra.productos_compra.all %}
            {
                nombre: "{{ item.producto.n_producto }}",
                cantidad: {{ item.cantidad_compra }},
                precio_neto: {{ item.precio_und }},
                subtotal_neto: {{ item.subtotal_prod }}
            },
            {% endfor %}
        ]
    },
    {% endfor %}
};

function calcularBruto(neto) {
    return neto * 1.19;
}

function calcularIva(neto) {
    return neto * 0.19;
}

function formatNumber(num) {
    return Math.round(num).toLocaleString('es-CL');
}

function verDetalleCompra(id) {
    const compra = comprasData[id];
    if (!compra) return;
    
    let totalNeto = compra.subtotal_neto;
    let totalIva = calcularIva(totalNeto);
    let totalBruto = calcularBruto(totalNeto);
    
    let productosHtml = compra.productos.map(p => {
        const precioBruto = calcularBruto(p.precio_neto);
        const subtotalBruto = calcularBruto(p.subtotal_neto);
        return `
            <tr class="border-b border-gray-100">
                <td class="py-3">${p.nombre}</td>
                <td class="py-3 text-center">${p.cantidad}</td>
                <td class="py-3 text-right">$${formatNumber(p.precio_neto)}</td>
                <td class="py-3 text-right text-gray-500">$${formatNumber(precioBruto)}</td>
                <td class="py-3 text-right font-medium">$${formatNumber(subtotalBruto)}</td>
            </tr>
        `;
    }).join('');
    
    document.getElementById('detalle-compra-contenido').innerHTML = `
        <div class="mb-4 p-4 bg-gray-50 rounded-lg grid grid-cols-3 gap-4">
            <div>
                <p class="text-sm text-gray-600">Folio</p>
                <p class="font-bold text-gray-900">${compra.folio}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Proveedor</p>
                <p class="font-bold text-gray-900">${compra.proveedor}</p>
            </div>
            <div>
                <p class="text-sm text-gray-600">Fecha</p>
                <p class="font-bold text-gray-900">${compra.fecha}</p>
            </div>
        </div>
        <table class="w-full">
            <thead class="bg-gray-100">
                <tr>
                    <th class="text-left py-3 px-2 text-sm font-semibold">Producto</th>
                    <th class="text-center py-3 px-2 text-sm font-semibold">Cant.</th>
                    <th class="text-right py-3 px-2 text-sm font-semibold">P.Neto</th>
                    <th class="text-right py-3 px-2 text-sm font-semibold">P.Bruto</th>
                    <th class="text-right py-3 px-2 text-sm font-semibold">Subtotal</th>
                </tr>
            </thead>
            <tbody>${productosHtml}</tbody>
            <tfoot class="bg-gray-50">
                <tr class="border-b">
                    <td colspan="4" class="py-2 text-right text-gray-600">Neto:</td>
                    <td class="py-2 text-right font-medium">$${formatNumber(totalNeto)}</td>
                </tr>
                <tr class="border-b">
                    <td colspan="4" class="py-2 text-right text-gray-600">IVA (19%):</td>
                    <td class="py-2 text-right font-medium text-orange-600">$${formatNumber(totalIva)}</td>
                </tr>
                <tr>
                    <td colspan="4" class="py-4 text-right font-bold">TOTAL BRUTO:</td>
                    <td class="py-4 text-right text-xl font-bold text-green-600">$${formatNumber(totalBruto)}</td>
                </tr>
            </tfoot>
        </table>
    `;
    
    document.getElementById('modal-detalle-compra').classList.remove('hidden');
    document.getElementById('modal-detalle-compra').classList.add('flex');
}

function cerrarModalCompra() {
    document.getElementById('modal-detalle-compra').classList.add('hidden');
    document.getElementById('modal-detalle-compra').classList.remove('flex');
}
</script>
{% endblock %}
