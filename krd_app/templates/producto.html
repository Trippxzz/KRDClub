<!DOCTYPE html>
<html lang="es">
{% extends 'base.html' %}
{% load static %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ prod.n_producto }} - KRD Club</title>
</head>
<body class="bg-white">
    <div class="max-w-7xl mx-auto px-6 py-20">
        <!-- Breadcrumb -->
        <div class="mb-8">
            <a href="{% url 'listar_productos' %}" class="text-gray-600 hover:text-black transition text-sm font-medium"><i class="fas fa-arrow-left mr-2"></i>Volver al cat√°logo</a>
        </div>

        <!-- Grid Producto -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-12">
            <!-- Imagen Producto -->
            <div>
                {% if imagenes_360_urls %}
                    <!-- Visor 360¬∞ -->
                    <div class="visor-360-wrapper">
                        <div id="visor-360-container" class="visor-360">
                            <div class="loading-spinner">
                                <div class="spinner"></div>
                                <p>Cargando vista 360¬∞...</p>
                            </div>
                            <div class="imagen-viewer"></div>
                        </div>
                        <div class="controles-360 text-center mt-4 text-gray-600 text-sm">
                            <p>üñ±Ô∏è Arrastra para rotar la vista 360¬∞</p>
                        </div>
                    </div>

                    <!-- Data JSON para el visor (oculto) -->
                    <div id="imagenes-360" 
                         data-urls='{{ imagenes_360_urls|safe }}' 
                         style="display:none;">
                    </div>
                {% else %}
                    <!-- Galer√≠a normal de im√°genes -->
                    <div class="bg-gray-100 rounded-lg overflow-hidden shadow-lg mb-6">
                        {% if imgs %}
                            {% with principal=imgs|dictsortreversed:"es_principal" %}
                                {% for img in principal %}
                                <img src="{{ img.imagen.url }}" alt="{{ prod.n_producto }}" id="imagen-principal" class="w-full h-auto object-cover" style="max-height: 600px;">
                                {% endfor %}
                            {% endwith %}
                        {% else %}
                            <div class="w-full h-96 flex items-center justify-center bg-gray-200">
                                <div class="text-center">
                                    <i class="fas fa-image text-6xl text-gray-400 mb-4"></i>
                                    <p class="text-gray-600">Imagen no disponible</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Im√°genes Thumbnails -->
                    {% if imgs %}
                    <div class="grid grid-cols-4 gap-3">
                        {% for img in imgs %}
                        <button onclick="document.getElementById('imagen-principal').src = '{{ img.imagen.url }}';" class="border-2 border-gray-300 hover:border-black rounded overflow-hidden transition hover:shadow-lg">
                            <img src="{{ img.imagen.url }}" alt="Thumbnail" class="w-full h-24 object-cover">
                        </button>
                        {% endfor %}
                    </div>
                    {% endif %}
                {% endif %}
            </div>

            <!-- Informaci√≥n Producto -->
            <div>
                <h1 class="text-4xl md:text-5xl font-bold text-black mb-6">{{ prod.n_producto }}</h1>
                
                <!-- Precio -->
                <div class="mb-8">
                    <p class="text-gray-600 text-sm tracking-[0.2em] uppercase mb-2">Precio</p>
                    <h2 class="text-5xl font-bold text-black">${{ prod.precio|floatformat:0 }}</h2>
                </div>

                <!-- Stock -->
                <div class="mb-8">
                    {% if prod.stock > 0 %}
                        <span class="inline-block bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-semibold">
                            <i class="fas fa-check-circle mr-2"></i>En Stock: {{ prod.stock }} unidades
                        </span>
                    {% else %}
                        <span class="inline-block bg-red-100 text-red-800 px-4 py-2 rounded-full text-sm font-semibold">
                            <i class="fas fa-times-circle mr-2"></i>Sin Stock
                        </span>
                    {% endif %}
                </div>

                <!-- Descripci√≥n -->
                <div class="mb-8 pb-8 border-b border-gray-200">
                    <p class="text-gray-700 text-lg leading-relaxed font-light">{{ prod.desc_producto }}</p>
                </div>

                <!-- Especificaciones -->
                {% if prod.aro or prod.ancho or prod.apernadura or prod.offset or prod.centro_llanta %}
                <div class="mb-8 pb-8 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-black mb-4">Especificaciones</h3>
                    <div class="grid grid-cols-2 gap-4">
                        {% if prod.aro %}
                        <div>
                            <p class="text-gray-600 text-sm">Aro</p>
                            <p class="font-semibold text-black">{{ prod.aro }}</p>
                        </div>
                        {% endif %}
                        {% if prod.ancho %}
                        <div>
                            <p class="text-gray-600 text-sm">Ancho</p>
                            <p class="font-semibold text-black">{{ prod.ancho }}</p>
                        </div>
                        {% endif %}
                        {% if prod.apernadura %}
                        <div>
                            <p class="text-gray-600 text-sm">Apernadura</p>
                            <p class="font-semibold text-black">{{ prod.apernadura }}</p>
                        </div>
                        {% endif %}
                        {% if prod.offset %}
                        <div>
                            <p class="text-gray-600 text-sm">Offset</p>
                            <p class="font-semibold text-black">{{ prod.offset }}</p>
                        </div>
                        {% endif %}
                        {% if prod.centro_llanta %}
                        <div>
                            <p class="text-gray-600 text-sm">Centro de llanta</p>
                            <p class="font-semibold text-black">{{ prod.centro_llanta }}</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Agregar al Carrito -->
                {% if prod.stock > 0 %}
                <div class="mb-8">
                    <form method="GET" action="{% url 'agregar_al_carrito' prod.id_producto %}" id="form-agregar-carrito">
                        <div class="mb-4">
                            <label for="cantidad" class="block text-sm font-medium text-gray-700 mb-2">Cantidad:</label>
                            <div class="flex items-center space-x-2">
                                <button type="button" onclick="decrementarCantidad()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded transition font-bold">‚àí</button>
                                <input type="number" 
                                       name="cantidad" 
                                       id="cantidad" 
                                       class="border-2 border-gray-300 focus:border-black outline-none px-4 py-2 rounded text-center font-semibold w-20" 
                                       value="1" 
                                       min="1" 
                                       max="{{ prod.stock }}">
                                <button type="button" onclick="incrementarCantidad()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded transition font-bold">+</button>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-black text-white px-8 py-4 font-medium tracking-wider hover:bg-gray-900 transition text-center text-sm rounded">
                            <i class="fas fa-shopping-cart mr-2"></i>AGREGAR AL CARRITO
                        </button>
                    </form>
                </div>
                {% else %}
                <div class="mb-8">
                    <button disabled class="w-full bg-gray-400 text-gray-200 px-8 py-4 font-medium tracking-wider cursor-not-allowed text-center text-sm rounded">
                        PRODUCTO NO DISPONIBLE
                    </button>
                </div>
                {% endif %}

                <!-- Mensaje de √©xito -->
                {% if request.GET.mensaje == 'ok' %}
                <div class="bg-green-100 border-l-4 border-green-600 text-green-800 p-4 rounded">
                    <p class="font-semibold"><i class="fas fa-check-circle mr-2"></i>Producto agregado al carrito</p>
                </div>
                {% endif %}

                <!-- Beneficios -->
                <div class="mt-8 pt-8 border-t border-gray-200 space-y-3">
                    <p class="flex items-center text-gray-700"><i class="fas fa-truck text-green-600 mr-3 w-5"></i>Env√≠o gratis en compras mayores a $500.000</p>
                    <p class="flex items-center text-gray-700"><i class="fas fa-undo text-green-600 mr-3 w-5"></i>Devoluciones sin costo en 30 d√≠as</p>
                    <p class="flex items-center text-gray-700"><i class="fas fa-shield-alt text-green-600 mr-3 w-5"></i>Garant√≠a de satisfacci√≥n 100%</p>
                </div>
            </div>
        </div>

        <!-- Botones de navegaci√≥n -->
        <div class="border-t border-gray-200 pt-8 flex flex-col sm:flex-row gap-4">
            <a href="{% url 'listar_productos' %}" class="flex-1 bg-white border-2 border-black text-black px-8 py-3 text-center font-medium tracking-wider hover:bg-black hover:text-white transition text-sm rounded">
                ‚Üê Volver al Cat√°logo
            </a>
        </div>
    </div>

    <!-- Notificaci√≥n de √©xito (flotante) -->
    <div id="notificacion-carrito" style="display:none;" class="fixed bottom-8 right-8 bg-green-600 text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 z-50">
        <i class="fas fa-check-circle text-lg"></i>
        <span>Producto agregado al carrito</span>
    </div>

    <link rel="stylesheet" href="{% static 'css/visor360.css' %}">
    <script src="{% static 'js/visor360.js' %}"></script>
    <script>
        const maxStock = {{ prod.stock }};
        
        function decrementarCantidad() {
            const input = document.getElementById('cantidad');
            input.value = Math.max(1, parseInt(input.value) - 1);
        }
        
        function incrementarCantidad() {
            const input = document.getElementById('cantidad');
            input.value = Math.min(maxStock, parseInt(input.value) + 1);
        }

        document.getElementById('form-agregar-carrito').addEventListener('submit', function(e) {
            e.preventDefault();
            const form = e.target;
            const url = form.action + '?cantidad=' + encodeURIComponent(form.cantidad.value);
            
            fetch(url, { 
                method: 'GET',
                credentials: 'same-origin'
            })
            .then(() => {
                // Mostrar notificaci√≥n
                const notif = document.getElementById('notificacion-carrito');
                notif.style.display = 'flex';
                
                // Actualizar contador del carrito si existe la funci√≥n
                if (typeof window.actualizarContadorCarrito === 'function') {
                    window.actualizarContadorCarrito();
                }
                
                // Ocultar notificaci√≥n despu√©s de 3 segundos
                setTimeout(() => {
                    notif.style.display = 'none';
                }, 3000);
            })
            .catch(err => {
                console.error('Error:', err);
                // En caso de error, redirigir normalmente
                window.location.href = url;
            });
        });
    </script>
</body>
{% endblock %}
</html>