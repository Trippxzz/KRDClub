{% extends "base.html" %}
{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4">
    <div class="max-w-md w-full">
        <!-- Logo y Título -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold tracking-[0.3em] text-black mb-2">KRD</h1>
            <p class="text-gray-600">Panel de Administración</p>
        </div>

        <!-- Card de Login -->
        <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-100">
            <div class="mb-6">
                <h2 class="text-xl font-bold text-gray-900">Iniciar Sesión</h2>
                {% comment %} <p class="text-sm text-gray-500 mt-1">Ingresa tus credenciales para acceder</p> {% endcomment %}
            </div>

            <!-- Mensajes -->
            {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                <div class="{% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-700{% else %}bg-blue-50 border-blue-200 text-blue-700{% endif %} border rounded-lg p-3 text-sm">
                    <i class="fas {% if message.tags == 'error' %}fa-exclamation-circle{% else %}fa-info-circle{% endif %} mr-2"></i>
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <form method="POST" id="login-form">
                {% csrf_token %}
                
                <!-- Campo RUT -->
                <div class="mb-4">
                    <label for="rut" class="block text-sm font-medium text-gray-700 mb-2">
                        RUT
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-id-card"></i>
                        </span>
                        <input type="text" 
                               name="rut" 
                               id="rut" 
                               value="{{ rut|default:'' }}"
                               placeholder="12.345.678-9"
                               class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-black focus:outline-none transition"
                               required
                               maxlength="12"
                               autocomplete="off">
                    </div>
                    <p id="rut-error" class="text-red-500 text-xs mt-1 hidden">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        RUT inválido
                    </p>
                    <p id="rut-valid" class="text-green-500 text-xs mt-1 hidden">
                        <i class="fas fa-check-circle mr-1"></i>
                        RUT válido
                    </p>
                </div>

                <!-- Campo Contraseña -->
                <div class="mb-4">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
                        Contraseña
                    </label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-lock"></i>
                        </span>
                        <input type="password" 
                               name="password" 
                               id="password" 
                               placeholder="••••••••"
                               class="w-full pl-10 pr-12 py-3 border-2 border-gray-200 rounded-lg focus:border-black focus:outline-none transition"
                               required>
                        <button type="button" 
                                onclick="togglePassword()" 
                                class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
                            <i class="fas fa-eye" id="eye-icon"></i>
                        </button>
                    </div>
                </div>

                <!-- Olvidé mi contraseña -->
                <div class="mb-6 text-right">
                    <button type="button" 
                            onclick="document.getElementById('modalRecuperar').classList.remove('hidden')"
                            class="text-sm text-gray-500 hover:text-black transition">
                        ¿Olvidaste tu contraseña?
                    </button>
                </div>

                <!-- Botón Submit -->
                <button type="submit" 
                        id="submit-btn"
                        class="w-full bg-black hover:bg-gray-800 text-white py-3 rounded-lg font-medium tracking-wider transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    INGRESAR
                </button>
            </form>
        </div>

        <!-- Link volver -->
        <div class="text-center mt-6">
            <a href="{% url 'home' %}" class="text-gray-500 hover:text-black text-sm transition">
                <i class="fas fa-arrow-left mr-2"></i>Volver al inicio
            </a>
        </div>
    </div>
</div>

<script>
// Formatear RUT mientras se escribe
const rutInput = document.getElementById('rut');
const rutError = document.getElementById('rut-error');
const rutValid = document.getElementById('rut-valid');

rutInput.addEventListener('input', function(e) {
    let value = e.target.value.replace(/[^0-9kK]/g, '').toUpperCase();
    
    if (value.length > 9) {
        value = value.slice(0, 9);
    }
    
    // Formatear con puntos y guión
    if (value.length > 1) {
        const cuerpo = value.slice(0, -1);
        const dv = value.slice(-1);
        
        let cuerpoFormateado = '';
        let contador = 0;
        
        for (let i = cuerpo.length - 1; i >= 0; i--) {
            cuerpoFormateado = cuerpo[i] + cuerpoFormateado;
            contador++;
            if (contador === 3 && i > 0) {
                cuerpoFormateado = '.' + cuerpoFormateado;
                contador = 0;
            }
        }
        
        e.target.value = cuerpoFormateado + '-' + dv;
    } else {
        e.target.value = value;
    }
    
    // Validar RUT
    validarRut(e.target.value);
});

function validarRut(rut) {
    // Limpiar RUT
    const rutLimpio = rut.replace(/[^0-9kK]/g, '').toUpperCase();
    
    if (rutLimpio.length < 2) {
        rutError.classList.add('hidden');
        rutValid.classList.add('hidden');
        return false;
    }
    
    const cuerpo = rutLimpio.slice(0, -1);
    const dv = rutLimpio.slice(-1);
    
    if (!/^\d+$/.test(cuerpo)) {
        rutError.classList.remove('hidden');
        rutValid.classList.add('hidden');
        return false;
    }
    
    // Calcular dígito verificador
    let suma = 0;
    let multiplo = 2;
    
    for (let i = cuerpo.length - 1; i >= 0; i--) {
        suma += parseInt(cuerpo[i]) * multiplo;
        multiplo = multiplo < 7 ? multiplo + 1 : 2;
    }
    
    const resto = suma % 11;
    let dvCalculado = 11 - resto;
    
    if (dvCalculado === 11) dvCalculado = '0';
    else if (dvCalculado === 10) dvCalculado = 'K';
    else dvCalculado = String(dvCalculado);
    
    if (dv === dvCalculado) {
        rutError.classList.add('hidden');
        rutValid.classList.remove('hidden');
        return true;
    } else {
        rutError.classList.remove('hidden');
        rutValid.classList.add('hidden');
        return false;
    }
}

// Toggle mostrar/ocultar contraseña
function togglePassword() {
    const passwordInput = document.getElementById('password');
    const eyeIcon = document.getElementById('eye-icon');
    
    if (passwordInput.type === 'password') {
        passwordInput.type = 'text';
        eyeIcon.classList.remove('fa-eye');
        eyeIcon.classList.add('fa-eye-slash');
    } else {
        passwordInput.type = 'password';
        eyeIcon.classList.remove('fa-eye-slash');
        eyeIcon.classList.add('fa-eye');
    }
}

// Validar antes de enviar
document.getElementById('login-form').addEventListener('submit', function(e) {
    const rut = document.getElementById('rut').value;
    if (!validarRut(rut)) {
        e.preventDefault();
        rutError.classList.remove('hidden');
        rutValid.classList.add('hidden');
        document.getElementById('rut').focus();
    }
});
</script>

<!-- Modal Recuperar Contraseña -->
<div id="modalRecuperar" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Recuperar Contraseña</h3>
                <button onclick="cerrarModalRecuperar()" class="text-gray-400 hover:text-gray-600 p-2">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <p class="text-gray-600 text-sm mb-6">
                Ingresa tu correo electrónico y te enviaremos instrucciones para restablecer tu contraseña.
            </p>
            
            <form id="form-recuperar" onsubmit="enviarRecuperacion(event)">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electrónico</label>
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-envelope"></i>
                        </span>
                        <input type="email" 
                               id="email-recuperar" 
                               placeholder="correo@ejemplo.com"
                               class="w-full pl-10 pr-4 py-3 border-2 border-gray-200 rounded-lg focus:border-black focus:outline-none transition"
                               required>
                    </div>
                </div>
                
                <!-- Mensaje de estado -->
                <div id="recuperar-status" class="hidden mb-4 p-3 rounded-lg text-sm"></div>
                
                <div class="flex gap-3">
                    <button type="button" 
                            onclick="cerrarModalRecuperar()"
                            class="flex-1 px-4 py-3 border-2 border-gray-200 text-gray-700 rounded-lg hover:bg-gray-50 transition font-medium">
                        Cancelar
                    </button>
                    <button type="submit" 
                            id="btn-recuperar"
                            class="flex-1 px-4 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>
                        Enviar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function cerrarModalRecuperar() {
    document.getElementById('modalRecuperar').classList.add('hidden');
    document.getElementById('email-recuperar').value = '';
    document.getElementById('recuperar-status').classList.add('hidden');
}

// Cerrar modal con Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        cerrarModalRecuperar();
    }
});

// Cerrar modal clickeando fuera
document.getElementById('modalRecuperar').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalRecuperar();
    }
});

function enviarRecuperacion(e) {
    e.preventDefault();
    
    const email = document.getElementById('email-recuperar').value.trim();
    const statusDiv = document.getElementById('recuperar-status');
    const btnRecuperar = document.getElementById('btn-recuperar');
    
    if (!email) {
        mostrarStatusRecuperar('Ingresa un correo electrónico', 'error');
        return;
    }
    
    // Deshabilitar botón
    btnRecuperar.disabled = true;
    btnRecuperar.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';
    
    // Enviar solicitud
    fetch('{% url "recuperar_password" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarStatusRecuperar(data.message, 'success');
            document.getElementById('email-recuperar').value = '';
            // Cerrar modal después de 3 segundos
            setTimeout(() => {
                cerrarModalRecuperar();
            }, 3000);
        } else {
            mostrarStatusRecuperar(data.message, 'error');
        }
    })
    .catch(error => {
        mostrarStatusRecuperar('Error al procesar la solicitud', 'error');
    })
    .finally(() => {
        btnRecuperar.disabled = false;
        btnRecuperar.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Enviar';
    });
}

function mostrarStatusRecuperar(mensaje, tipo) {
    const statusDiv = document.getElementById('recuperar-status');
    statusDiv.classList.remove('hidden', 'bg-green-50', 'text-green-700', 'border-green-200', 'bg-red-50', 'text-red-700', 'border-red-200');
    
    if (tipo === 'success') {
        statusDiv.classList.add('bg-green-50', 'text-green-700', 'border', 'border-green-200');
        statusDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + mensaje;
    } else {
        statusDiv.classList.add('bg-red-50', 'text-red-700', 'border', 'border-red-200');
        statusDiv.innerHTML = '<i class="fas fa-exclamation-circle mr-2"></i>' + mensaje;
    }
}
</script>
{% endblock %}
