{% extends 'panel/base_admin.html' %}
{% load formato_precio %}

{% block title %}Dashboard{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}

<!-- Acciones Rápidas -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 mb-6">
    <h2 class="text-lg font-bold text-gray-800 mb-4">Acciones Rápidas</h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="{% url 'crear_producto' %}" class="flex flex-col items-center p-4 bg-blue-50 rounded-lg hover:bg-blue-100 transition">
            <i class="fas fa-plus-circle text-blue-600 text-2xl mb-2"></i>
            <span class="text-xs md:text-sm font-medium text-blue-800 text-center">Nuevo Producto</span>
        </a>
        <a href="{% url 'crear_compra' %}" class="flex flex-col items-center p-4 bg-green-50 rounded-lg hover:bg-green-100 transition">
            <i class="fas fa-truck text-green-600 text-2xl mb-2"></i>
            <span class="text-xs md:text-sm font-medium text-green-800 text-center">Registrar Compra</span>
        </a>
        <a href="{% url 'admin_logistica' %}" class="flex flex-col items-center p-4 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition">
            <i class="fas fa-shipping-fast text-yellow-600 text-2xl mb-2"></i>
            <span class="text-xs md:text-sm font-medium text-yellow-800 text-center">Gestionar Envíos</span>
        </a>
        <a href="{% url 'agregar_vehiculos' %}" class="flex flex-col items-center p-4 bg-purple-50 rounded-lg hover:bg-purple-100 transition">
            <i class="fas fa-car text-purple-600 text-2xl mb-2"></i>
            <span class="text-xs md:text-sm font-medium text-purple-800 text-center">Agregar Vehículo</span>
        </a>
    </div>
</div>

<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <!-- Ventas Hoy -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs md:text-sm text-gray-500 font-medium">Ventas Hoy</p>
                <p class="text-xl md:text-3xl font-bold text-gray-900 font-precio">${{ ingresos_hoy|floatformat:0|formato_miles }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ ventas_hoy }} orden{{ ventas_hoy|pluralize:"es" }}</p>
            </div>
            <div class="bg-green-100 p-3 rounded-xl hidden sm:block">
                <i class="fas fa-dollar-sign text-green-600 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Ventas Semana -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs md:text-sm text-gray-500 font-medium">Esta Semana</p>
                <p class="text-xl md:text-3xl font-bold text-gray-900 font-precio">${{ ingresos_semana|floatformat:0|formato_miles }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ ventas_semana }} orden{{ ventas_semana|pluralize:"es" }}</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-xl hidden sm:block">
                <i class="fas fa-chart-line text-blue-600 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Ventas Mes -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs md:text-sm text-gray-500 font-medium">Este Mes</p>
                <p class="text-xl md:text-3xl font-bold text-gray-900 font-precio">${{ ingresos_mes|floatformat:0|formato_miles }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ ventas_mes }} orden{{ ventas_mes|pluralize:"es" }}</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-xl hidden sm:block">
                <i class="fas fa-calendar text-purple-600 text-xl"></i>
            </div>
        </div>
    </div>
    
    <!-- Envíos Pendientes -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-xs md:text-sm text-gray-500 font-medium">Envíos Pendientes</p>
                <p class="text-xl md:text-3xl font-bold {% if envios_pendientes > 0 %}text-yellow-600{% else %}text-gray-900{% endif %}">{{ envios_pendientes }}</p>
                <p class="text-xs text-gray-400 mt-1">{{ envios_enviados }} en tránsito</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-xl hidden sm:block">
                <i class="fas fa-shipping-fast text-yellow-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Gráficos -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Gráfico Ventas 7 días -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Ventas Últimos 7 Días</h3>
        <div class="h-64">
            <canvas id="chart-7dias"></canvas>
        </div>
    </div>
    
    <!-- Gráfico Ventas Mensuales -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Ventas Últimos 6 Meses</h3>
        <div class="h-64">
            <canvas id="chart-mensual"></canvas>
        </div>
    </div>
</div>

<!-- Estadísticas adicionales y listas -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">    
    <!-- Productos Más Vendidos -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Más Vendidos</h3>
        {% if productos_vendidos %}
        <div class="space-y-3">
            {% for prod in productos_vendidos %}
            <div class="flex justify-between items-center py-2 {% if not forloop.last %}border-b border-gray-100{% endif %}">
                <span class="text-gray-700 text-sm truncate mr-2" title="{{ prod.id_producto__n_producto }}">{{ prod.id_producto__n_producto|truncatechars:25 }}</span>
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold whitespace-nowrap">{{ prod.total_vendido }} vendidos</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-gray-500 text-sm text-center py-4">Sin datos de ventas</p>
        {% endif %}
    </div>
    
    <!-- Productos Bajo Stock -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
            <h3 class="text-lg font-bold text-gray-800">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>Bajo Stock
            </h3>
            <form method="post" class="flex items-center gap-2" id="formUmbralStock">
                {% csrf_token %}
                <label for="umbral_stock" class="text-xs text-gray-600 whitespace-nowrap">Umbral ≤</label>
                <input type="number" 
                       name="umbral_stock" 
                       id="umbral_stock" 
                       value="{{ umbral_bajo_stock }}" 
                       min="0" 
                       max="100" 
                       class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center"
                       onchange="this.form.submit()">
                <span class="text-xs text-gray-500">unid.</span>
            </form>
        </div>
        {% if productos_bajo_stock %}
        <div class="space-y-3 max-h-64 overflow-y-auto">
            {% for prod in productos_bajo_stock %}
            <div class="flex justify-between items-center py-2 {% if not forloop.last %}border-b border-gray-100{% endif %}">
                <span class="text-gray-700 text-sm truncate mr-2">{{ prod.n_producto|truncatechars:25 }}</span>
                <span class="{% if prod.stock == 0 %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %} px-2 py-1 rounded-full text-xs font-bold">
                    {{ prod.stock }} unid.
                </span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-green-600 text-sm text-center py-4">
            <i class="fas fa-check-circle mr-2"></i>Todo el stock OK
        </p>
        {% endif %}
    </div>
    <!-- Últimas Ventas -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-gray-800">Últimas Ventas</h3>
        <a href="{% url 'admin_ventas' %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
            Ver todas <i class="fas fa-arrow-right ml-1"></i>
        </a>
    </div>
    <div class="overflow-x-auto">
        <table class="w-full min-w-[400px]">
            <thead class="bg-gray-50">
                <tr>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-600 uppercase">ID</th>
                    <th class="text-left px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Fecha</th>
                    <th class="text-right px-4 py-3 text-xs font-semibold text-gray-600 uppercase">Total</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for venta in ultimas_ventas %}
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <span class="font-mono font-bold text-blue-600">#{{ venta.id }}</span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-600">
                        {{ venta.fecha_venta|date:"d/m/Y H:i" }}
                    </td>
                    <td class="px-4 py-3 text-right">
                        <span class="font-bold text-gray-900 font-precio">${{ venta.precio_venta|floatformat:0|formato_miles }}</span>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" class="px-4 py-8 text-center text-gray-500">
                        No hay ventas registradas
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

</div>


<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Estadísticas Totales -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 md:p-6">
        <h3 class="text-lg font-bold text-gray-800 mb-4">Resumen Total</h3>
        <div class="space-y-4">
            <div class="flex justify-between items-center py-3 border-b border-gray-100">
                <span class="text-gray-600">Total Ventas Históricas</span>
                <span class="font-bold text-gray-900">{{ total_ventas }}</span>
            </div>
            <div class="flex justify-between items-center py-3 border-b border-gray-100">
                <span class="text-gray-600">Ingresos Totales</span>
                <span class="font-bold text-green-600 font-precio">${{ total_ingresos|floatformat:0|formato_miles }}</span>
            </div>
            <div class="flex justify-between items-center py-3 border-b border-gray-100">
                <span class="text-gray-600">Productos en Catálogo</span>
                <span class="font-bold text-gray-900">{{ total_productos }}</span>
            </div>
            <div class="flex justify-between items-center py-3">
                <span class="text-gray-600">Stock Total</span>
                <span class="font-bold text-gray-900">{{ total_stock }} unid.</span>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Datos desde Django
    const ventas7Dias = {{ ventas_7_dias|safe }};
    const labels7Dias = {{ labels_7_dias|safe }};
    const ventasMensuales = {{ ventas_mensuales|safe }};
    const labelsMensuales = {{ labels_mensuales|safe }};
    
    // Formatear números
    function formatCLP(value) {
        return '$' + value.toLocaleString('es-CL');
    }
    
    // Gráfico 7 días
    const ctx7dias = document.getElementById('chart-7dias').getContext('2d');
    new Chart(ctx7dias, {
        type: 'bar',
        data: {
            labels: labels7Dias,
            datasets: [{
                label: 'Ventas',
                data: ventas7Dias,
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 1,
                borderRadius: 6,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return formatCLP(context.raw);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
                            if (value >= 1000) return '$' + (value/1000).toFixed(0) + 'K';
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
    
    // Gráfico Mensual
    const ctxMensual = document.getElementById('chart-mensual').getContext('2d');
    new Chart(ctxMensual, {
        type: 'line',
        data: {
            labels: labelsMensuales,
            datasets: [{
                label: 'Ventas',
                data: ventasMensuales,
                borderColor: 'rgba(34, 197, 94, 1)',
                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return formatCLP(context.raw);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) return '$' + (value/1000000).toFixed(1) + 'M';
                            if (value >= 1000) return '$' + (value/1000).toFixed(0) + 'K';
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
});
</script>
{% endblock %}
