{% extends 'base.html' %}
{% load static %}
{% load formato_precio %}

{% block title %}{{ prod.n_producto }} - KRD Club{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/producto.css' %}">
<link rel="stylesheet" href="{% static 'css/visor360.css' %}">
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-20">
    <!-- Breadcrumb Premium -->
    <div class="mb-10">
        <a href="{% url 'listar_productos' %}" class="inline-flex items-center gap-3 text-gray-500 hover:text-black transition-all duration-300 text-sm font-light tracking-wide group">
            <span class="w-8 h-8 rounded-full border border-gray-300 flex items-center justify-center group-hover:border-black group-hover:bg-black group-hover:text-white transition-all duration-300">
                <i class="fas fa-arrow-left text-xs"></i>
            </span>
            <span class="uppercase tracking-widest text-xs">Volver al cat√°logo</span>
        </a>
    </div>

    <!-- Grid Producto -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 mb-16">
        <!-- Imagen Producto -->
        <div>
            {% if sprite_360_data %}
                 {% comment %} Visor 360 hace 1 sola peticion http {% endcomment %}
                <div class="visor-360-wrapper">
                    <div id="visor-360-container" class="visor-360">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Cargando vista 360¬∞...</p>
                        </div>
                        <div class="imagen-viewer"></div>
                    </div>
                    <div class="controles-360 text-center mt-4 text-gray-600 text-sm">
                        <p>üñ±Ô∏è Arrastra para rotar la vista 360¬∞</p>
                    </div>
                </div>

                <!-- Data JSON para el visor sprite (oculto) -->
                <div id="sprite-360-data" 
                     data-sprite='{{ sprite_360_data|safe }}' 
                     style="display:none;">
                </div>
            {% else %}
                <!-- Galer√≠a normal de im√°genes -->
                <div class="bg-gray-100 rounded-lg overflow-hidden shadow-lg mb-6">
                    {% if imgs %}
                        {% with principal=imgs|dictsortreversed:"es_principal" %}
                            {% for img in principal %}
                            <img src="{{ img.imagen.url }}" alt="{{ prod.n_producto }}" id="imagen-principal" class="producto-imagen-principal">
                            {% endfor %}
                        {% endwith %}
                    {% else %}
                        <div class="w-full h-96 flex items-center justify-center bg-gray-200">
                            <div class="text-center">
                                <i class="fas fa-image text-6xl text-gray-400 mb-4"></i>
                                <p class="text-gray-600">Imagen no disponible</p>
                            </div>
                        </div>
                    {% endif %}
                </div>

                <!-- Im√°genes Thumbnails -->
                {% if imgs %}
                <div class="producto-thumbnails">
                    {% for img in imgs %}
                    <button onclick="cambiarImagenPrincipal('{{ img.imagen.url }}')" 
                            data-url="{{ img.imagen.url }}"
                            class="producto-thumbnail">
                        <img src="{{ img.imagen.url }}" alt="Thumbnail">
                    </button>
                    {% endfor %}
                </div>
                {% endif %}
            {% endif %}
        </div>

        <!-- Informaci√≥n Producto -->
        <div class="lg:pl-8">
            <!-- Subt√≠tulo de categor√≠a -->
            
            <h1 class="producto-titulo ">{{ prod.n_producto }}</h1>
            
            <div class="separador-premium"></div>
            
            <!-- Precio -->
            <div class="mb-10">
                <p class="text-gray-400 text-xs tracking-[0.2em] uppercase mb-3 font-light">Precio</p>
                <h2 class="producto-precio font-precio">${{ prod.precio|formato_miles }}</h2>
            </div>

            <!-- Stock -->
            <div class="mb-10">
                {% if prod.stock > 0 %}
                    <span class="producto-stock en-stock">
                        <i class="fas fa-check-circle mr-2"></i>En Stock: {{ prod.stock }} unidades
                    </span>
                {% else %}
                    <span class="producto-stock sin-stock">
                        <i class="fas fa-times-circle mr-2"></i>Sin Stock
                    </span>
                {% endif %}
            </div>

            <!-- Descripci√≥n -->
            <div class="mb-10 pb-10 border-b border-gray-100">
                <p class="text-gray-400 text-xs tracking-[0.2em] uppercase mb-3 font-light">Descripci√≥n</p>
                <p class="text-gray-600 text-lg leading-relaxed font-light">{{ prod.desc_producto|linebreaksbr }}</p>
            </div>

            <!-- Especificaciones -->
            {% if prod.aro or prod.ancho or prod.apernadura or prod.offset or prod.centro_llanta %}
            <div class="mb-10 pb-10 border-b border-gray-100">
                <h3 class="text-xs font-medium text-gray-400 uppercase tracking-[0.2em] mb-6">Especificaciones T√©cnicas</h3>
                <div class="especificaciones-grid">
                    {% if prod.aro %}
                    <div class="especificacion-item">
                        <p class="especificacion-label">Aro</p>
                        <p class="especificacion-value">{{ prod.aro }}"</p>
                    </div>
                    {% endif %}
                    {% if prod.ancho %}
                    <div class="especificacion-item">
                        <p class="especificacion-label">Ancho</p>
                        <p class="especificacion-value">{{ prod.ancho }}</p>
                    </div>
                    {% endif %}
                    {% if prod.apernadura %}
                    <div class="especificacion-item">
                        <p class="especificacion-label">Apernadura</p>
                        <p class="especificacion-value">{{ prod.apernadura }}</p>
                    </div>
                    {% endif %}
                    {% if prod.offset %}
                    <div class="especificacion-item">
                        <p class="especificacion-label">Offset</p>
                        <p class="especificacion-value">{{ prod.offset }}</p>
                    </div>
                    {% endif %}
                    {% if prod.centro_llanta %}
                    <div class="especificacion-item">
                        <p class="especificacion-label">Centro de llanta</p>
                        <p class="especificacion-value">{{ prod.centro_llanta }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Agregar al Carrito -->
            {% if prod.stock > 0 %}
            <div class="mb-10">
                <form method="GET" action="{% url 'agregar_al_carrito' prod.id_producto %}" id="form-agregar-carrito">
                    <div class="mb-6">
                        <label for="cantidad" class="block text-xs font-medium text-gray-400 uppercase tracking-[0.15em] mb-3">Cantidad</label>
                        <div class="cantidad-selector">
                            <button type="button" onclick="decrementarCantidad()" class="cantidad-btn">‚àí</button>
                            <input type="number" 
                                   name="cantidad" 
                                   id="cantidad" 
                                   class="cantidad-input" 
                                   value="1" 
                                   min="1" 
                                   max="{{ prod.stock }}">
                            <button type="button" onclick="incrementarCantidad()" class="cantidad-btn">+</button>
                        </div>
                    </div>
                    <div class="nota-info mb-8">
                        <p>
                            <i class="fas fa-info-circle mr-2 text-amber-600"></i>
                            <strong>Nota:</strong> Las llantas se venden en juegos de 4 unidades (m√∫ltiplos de 4).
                        </p>
                    </div>
                    <button type="submit" class="btn-agregar-carrito">
                        <i class="fas fa-shopping-bag"></i>
                        <span>Agregar al Carrito</span>
                    </button>
                </form>
            </div>
            {% else %}
            <div class="mb-10">
                <button disabled class="btn-no-disponible">
                    <i class="fas fa-times-circle mr-2"></i>Producto No Disponible
                </button>
            </div>
            {% endif %}

            <!-- Mensaje de √©xito -->
            {% if request.GET.mensaje == 'ok' %}
            <div class="mensaje-exito mb-10">
                <p><i class="fas fa-check-circle mr-2"></i>Producto agregado al carrito exitosamente</p>
            </div>
            {% endif %}

            <!-- Veh√≠culos Compatibles -->
            {% if vehiculos_compatibles %}
            <div class="mb-10 pb-10 border-b border-gray-100">
                <h3 class="text-xs font-medium text-gray-400 uppercase tracking-[0.2em] mb-6 flex items-center gap-2">
                    <i class="fas fa-car text-amber-500"></i>Veh√≠culos Compatibles
                </h3>
                <div class="vehiculos-tabla">
                    <table>
                        <thead>
                            <tr>
                                <th>Marca</th>
                                <th>Modelo</th>
                                <th>Motor</th>
                                <th>A√±o</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pv in vehiculos_compatibles %}
                            <tr>
                                <td>{{ pv.vehiculo.marca }}</td>
                                <td>{{ pv.vehiculo.modelo }}</td>
                                <td>{{ pv.vehiculo.cilindrada }}L</td>
                                <td>{{ pv.vehiculo.anio }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <!-- Beneficios -->
            <div class="beneficios-lista">
                <p class="beneficio-item"><i class="fas fa-truck"></i><span>Env√≠o gratis en compras mayores a $500.000</span></p>
                <p class="beneficio-item"><i class="fas fa-undo"></i><span>Devoluciones sin costo en 30 d√≠as</span></p>
                <p class="beneficio-item"><i class="fas fa-shield-alt"></i><span>Garant√≠a de satisfacci√≥n 100%</span></p>
            </div>
        </div>
    </div>

    <!-- Botones de navegaci√≥n -->
    <div class="border-t border-gray-100 pt-10 flex flex-col sm:flex-row gap-4">
        <a href="{% url 'listar_productos' %}" class="flex-1 group relative overflow-hidden bg-white border border-gray-200 text-gray-700 px-8 py-4 text-center font-light tracking-[0.15em] uppercase text-xs rounded-lg transition-all duration-300 hover:border-black hover:text-black">
            <span class="relative z-10 flex items-center justify-center gap-3">
                <i class="fas fa-arrow-left transition-transform duration-300 group-hover:-translate-x-1"></i>
                Volver al Cat√°logo
            </span>
        </a>
    </div>
</div>

<!-- Notificaci√≥n de √©xito (flotante) -->
<div id="notificacion-carrito" class="notificacion-carrito">
    <i class="fas fa-check-circle text-lg"></i>
    <span>Producto agregado al carrito</span>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/visor360.js' %}"></script>
<script src="{% static 'js/producto.js' %}"></script>
<script>
    // Inicializar m√≥dulo de producto con el stock actual
    document.addEventListener('DOMContentLoaded', function(){
        initProducto({{ prod.stock|default:0 }});
    });
</script>
{% endblock %}
